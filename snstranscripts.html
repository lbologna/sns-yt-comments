<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
  <title>SNS trascrizioni</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
</head>

<style>
  .main-div {
    margin-top: 5px;
    margin-bottom: 5px;
  }

  .curationSpanStyle {
    border: solid;
    border-width: 1px;
    border-color: aliceblue;
    color: aliceblue;
    text-align: center;
    font-size: 10px;
    vertical-align: middle;
  }
</style>

<!-- static html content -->
<body id="body" onload="execute()">

  <!-- curation info modal -->
  <div class="modal fade" id="curation-info-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div id="curation-info-modal-header" class="modal-header">
          <h6 id="info-modal" class="modal-title"></h6>
          <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
      </div>
    </div>
  </div>

    <!-- successful save text modal -->
    <div class="modal fade" id="success-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div id="success-modal-header" class="modal-header bg-success bg-gradient border border-success text-light">
            <h5 class="modal-title">Trascrizione salvata con successo!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
          </div>
        </div>
      </div>
    </div>

  <!-- error modal -->
  <div class="modal fade" id="error-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-light">
          <h5 class="modal-title">ERRORE!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <p id="error-message">Password errata o assente!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- name insertion modal -->
  <div class="modal fade" id="curator-modal" tabindex="-1" aria-labelledby="nameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="nameModalLabel">Chi ha curato questa trascrizione?</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="curator-input" required>Nome/i*</span>
            </div>
            <input id="curator-input-text" type="text" class="form-control" aria-label="Default"
              aria-describedby="curator-input" required>
          </div>
          <span><i>* campo obbligatorio</i></span>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" id="curator-modal-ok-btn" class="btn btn-primary">Ok</button>
        </div>
      </div>
    </div>
  </div>

  <!-- password insertion modal -->
  <div class="modal fade" id="pwd-modal" tabindex="-1" aria-labelledby="pwdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="pwdModalLabel">Inserisci la password necessaria per la modifica dei
            contenuti.</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="pwd-input">Password</span>
            </div>
            <input id="pwd-input-text" type="password" class="form-control" aria-label="Default"
              aria-describedby="pwd-input" required>
          </div>
        </div>
        <!-- Footer with buttons -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" id="pwdModalOkBtn" class="btn btn-primary">Ok</button>
        </div>
      </div>
    </div>
  </div>



  <!-- create mainDiv for button row -->
  <div id="mainDiv" class="sticky-top">
    <div class="container sticky-top main-div bg-white">
      <div class="row justify-content-md-center">
        <button class="top-btns btn btn-sm btn-outline-dark rounded-pill col-2" onclick='window.location.reload();'><i
            class='bi bi-arrow-repeat'></i></button>
        <button id="openAllBtn" class="top-btns btn btn-sm btn-outline-success rounded-pill col-4 ">Apri tutti</button>
        <button id="closeAllBtn" class="top-btns btn btn-sm btn-outline-success rounded-pill  col-4">Chiudi
          tutti</button>
        <button class="top-btns btn btn-sm btn-outline-dark rounded-pill col-1" onclick='window.scrollTo(0, 0)'><i
            class='bi bi-arrow-up'></i></button>
        <button class="top-btns btn btn-sm btn-outline-dark rounded-pill col-1"
          onclick='window.scrollTo(0, document.body.scrollHeight)'><i class='bi bi-arrow-down '></i></button>
      </div>
    </div>
  </div>

  <div id="spinner" class="d-flex justify-content-center" style="margin-top: 30px;">
    <div class="spinner-grow text-primary" role="status">
    </div>
  </div>
</body>

<script>
  let lastClickedModifyId = "";
  localStorage.setItem('pwd', "");
  let curationInfo = "";

  if (window.location.href.includes("https://lbologna.github.io")) {
    mainurl = "https://lucaleonardobologna.it";
  } else if (window.location.href.includes("http://127.0.0.1:")) {
    mainurl = "http://127.0.0.1:5000";
  }

  let transcriptUrl = mainurl + "/snstranscripts/";
  let saveUrl = mainurl + "/savesnstranscripts/";
  let checkUrl = mainurl + "/checkpwd/";
  let modifyColorStyle = "background-color:rgb(240,240,245); color:rgb(0,0,90)";
  let currentSaveBtnId = "";

  async function execute() {
    $('#mainDiv').hide();
    $('#collapse-div').hide();
    document.getElementById("spinner").classList.add("d-block");


    const snsTranscript = await fetch(transcriptUrl);
    const jsonSnSTranscript = await snsTranscript.json();

    const snsVideoInfo = await fetch(mainurl + "/getsnsjson/");
    const snsVideoJson = await snsVideoInfo.json();

    await populate(snsVideoJson, jsonSnSTranscript);
    hideSpinner();
  }

  function hideSpinner() {
    $('#mainDiv').show();
    $('#collapse-div').show();
    document.getElementById("spinner").classList.add("d-none");
  }

  function populate(snsVideoJson, jsonSnSTranscript) {
    let video_id_ts_list = jsonSnSTranscript["video_id_ts_list"]
    let keys = Object.keys(jsonSnSTranscript);
    let counter = video_id_ts_list.length;
    video_id_ts_list.forEach(element => {
      // collapsible div
      let collapseDiv = document.createElement("div");
      collapseDiv.classList.add("container")
      collapseDiv.setAttribute("id", "collapse-div")
      collapseDiv.setAttribute("style", "margin-top:8px; margin-bottom:12px; border-bottom:solid; border-bottom-width:2px; border-bottom-color:rgb(220, 220, 250)")

      // collapsible button row
      let collapseBtnDiv = document.createElement("div");
      collapseBtnDiv.classList.add("row");

      // link buttons row
      let clickBtnsDiv = document.createElement("div");
      clickBtnsDiv.setAttribute("style", "margin-top:2px; margin-bottom:2px");
      clickBtnsDiv.classList.add("row");

      // collapsible main button
      let caButton = document.createElement("a");
      caButton.classList.add("btn", "btn-primary", "btn-block", "col-12")
      caButton.setAttribute("id", "cbt_" + element);
      caButton.setAttribute("data-bs-toggle", "collapse")
      caButton.setAttribute("href", "#".concat(element))
      caButton.setAttribute("role", "button")
      caButton.setAttribute("aria-expanded", "false")
      caButton.setAttribute("aria-controls", element)
      caButton.innerHTML = snsVideoJson[element]["title"] + " (" + snsVideoJson[element]["videoPublishedAt"].substr(0, 10) + " | ~" + jsonSnSTranscript[element]["duration"] +  " min.) - #" + counter.toString();
      collapseBtnDiv.appendChild(caButton);
      counter -= 1;

      // text parent div
      let contentDiv = document.createElement("div");
      contentDiv.classList.add("collapse", "my-collapse-div")
      contentDiv.setAttribute("id", element)

      // text div
      let textDiv = document.createElement("div");
      textDiv.classList.add("card", "card-body")
      textDiv.setAttribute("id", "txt_" + element)
      textDiv.setAttribute("style", modifyColorStyle);
      textDiv.innerHTML = jsonSnSTranscript[element]["text"]

      // modify button
      let modifyButton = document.createElement("button");
      let modifyButtonId = "mod_" + element;
      modifyButton.setAttribute("id", modifyButtonId)
      modifyButton.setAttribute("type", "button");
      modifyButton.innerHTML = "Modifica";
      modifyButton.classList.add("btn", "btn-outline-secondary", "btn-sm", "col-4");

      // save button
      let saveButton = document.createElement("button");
      let saveButtonId = "save_" + element;
      saveButton.setAttribute("id", saveButtonId);
      saveButton.setAttribute("type", "button")
      saveButton.innerHTML = "Salva";
      saveButton.classList.add("btn", "btn-outline-danger", "btn-sm", "col-4");
      saveButton.setAttribute("disabled", "");

      // video url button
      let videoButton = document.createElement("button"); // video url paragraph
      let videoUrl = "https://www.youtube.com/watch?v=" + element
      videoButton.classList.add("btn", "btn-outline-info", "btn-sm", "col-3");
      videoButton.innerHTML = "Video";
      videoButton.setAttribute("onclick", "window.open('" + videoUrl + "'),'_blank'");

      // curation url button
      let curationButton = document.createElement("button"); // video url paragraph
      curationButton.classList.add("col-1", "btn", "btn-sm", "curationSpanStyle");
      curationButton.setAttribute("type", "button");
      curationButton.setAttribute("id", "curinfo_" + element);
      curationButton.addEventListener("click", showCurationInfo);
      let curator = jsonSnSTranscript[element]["modified_by"].trim();
      let curationText = "";
      if (curator == "") {
        curationText = "Trascrizione non curata"
        fillCurationBtn(curationButton, curationText, "NC")
      } else {
        curationText = "Trascrizione curata da:<br>" + jsonSnSTranscript[element]["modified_by"];
        fillCurationBtn(curationButton, curationText, "C");
      }

      clickBtnsDiv.appendChild(modifyButton);
      clickBtnsDiv.appendChild(saveButton);
      clickBtnsDiv.appendChild(videoButton);
      clickBtnsDiv.appendChild(curationButton);

      contentDiv.appendChild(textDiv)

      collapseDiv.appendChild(collapseBtnDiv)
      collapseDiv.appendChild(clickBtnsDiv)
      collapseDiv.appendChild(contentDiv)

      document.body.appendChild(collapseDiv)

      document.getElementById(modifyButtonId).onclick = modifyCheck;
      document.getElementById(saveButtonId).onclick = showCuratorModal;
      document.getElementById("curator-modal-ok-btn").onclick = save;
      document.getElementById("openAllBtn").onclick = openAll;
      document.getElementById("closeAllBtn").onclick = closeAll;
      document.getElementById("pwdModalOkBtn").onclick = pwdCheck;
    })
  }

  function fillCurationBtn(element, text, status){
    if (status=="NC"){
      element.classList.remove("bg-success");

    element.classList.add("bg-secondary");

  } else {
    element.classList.remove("bg-secondary");

    element.classList.add("bg-success");
  }
    element.setAttribute("title", text);
    element.innerHTML = status;
  }
  async function pwdCheck() {
    //let names = document.getElementById('curator-input-text').value;
    let pwd = document.getElementById('pwd-input-text').value;
    // request to endpoint
    const request = new Request(checkUrl, {
      headers: {
        "Content-Type": "application/json",
      },
      method: "POST",
      body: JSON.stringify({ "pwd": pwd }),
    });

    // read response
    const checkResponse = await fetch(request);
    const checkResponseJson = await checkResponse.json();

    // if success
    if (checkResponseJson["responseStatus"] == "ok") {
      localStorage.setItem('pwd', "ok"); // save password to tab
      $('#pwd-modal').modal('hide'); // hide password insertion modal
      // activate corresponding "Salva" button
      enableModifyContentDiv(lastClickedModifyId);
    } else {
      $('#pwd-modal').modal('hide');
      $('#error-modal').modal('show');
      $('#error-message')[0].innerHTML = "Password errata o assente!";
    }
  }

  // check whether the text panel can be made editable for modifications
  function modifyCheck() {
    if (localStorage.getItem('pwd') == "ok") {
      enableModifyContentDiv(this.id);
    } else {
      lastClickedModifyId = this.id;
      $('#pwd-modal').modal('show');
    }
  }

  // enable save button
  function enableSaveButton(currentElId) {
    let key = extractElementId(id);
    $("#save_" + id).attr("disabled", false);
  }

  // enable text div for modification
  function enableModifyContentDiv(currentElId) {
    let key = extractElementId(currentElId);
    let textDivId = "#txt_" + key;
    let contentDivId = "#" + key;
    let currentSaveBtnId = "#save_" + key;

    $(contentDivId).addClass("show");
    $(textDivId).css({ "background-color": "white", "color": "black" });
    $(textDivId).attr("contenteditable", true);
    $(textDivId).addClass("editable");
    $(currentSaveBtnId).attr("disabled", false);
  }

  // check password before saving
  function showCuratorModal() {
    currentSaveBtnId = this.id;
    $('#curator-modal').modal('show');
  }

  // save new content to transcripts file
  async function save() {
    let curatorName = $("#curator-input-text").val();
    if (curatorName.trim() == "") {
      $("#curator-modal").modal('hide');
      $('#error-modal').modal('show');
      $('#error-message')[0].innerHTML = "Il campo 'Nome/i' Ã¨ obbligatorio!";
    } else {
      let key = extractElementId(currentSaveBtnId);
      let textDivId = "#txt_" + key;
      $(textDivId).attr("style", modifyColorStyle);
      $(textDivId).attr("contenteditable", false);
      $(textDivId).removeClass("editable");
      let crrCurationButton = $("#curinfo_" + key)[0]
      fillCurationBtn(crrCurationButton, "Trascrizione curata da:<br>" + curatorName, "C")

      const request = new Request(saveUrl, {
        headers: {
          "Content-Type": "application/json",
        },
        method: "POST",
        body: JSON.stringify({ "id": key, "text": $(textDivId)[0].innerHTML, "curator": curatorName }),
      });

      const checkResponse = await fetch(request);
      const checkResponseJson = await checkResponse.json();
      $("#curator-modal").modal('hide');
      $('#success-modal').modal('show');

    }
  }
  // open all text panels
  function openAll() {
    let allDivs = document.querySelectorAll(".my-collapse-div");
    allDivs.forEach(item => { item.classList.add("show") })
  }

  // close all text panels
  function closeAll() {
    let allDivs = document.querySelectorAll(".my-collapse-div");
    allDivs.forEach(item => { item.classList.remove("show") })
  }

  // show modal with curators name(s)
  function showCurationInfo() {
    document.getElementById("info-modal").innerHTML = this.title;
    let status = this.innerHTML;
    console.log(status)
    if (status == "C"){
      $('#curation-info-modal-header').removeClass("bg-secondary text-light");
      $('#curation-info-modal-header').addClass("bg-success text-light");

      $('#curation-info-modal-header').removeClass("border-secondary");
      $('#curation-info-modal-header').addClass("border-success");
    } else {
      $('#curation-info-modal-header').removeClass("bg-success text-light");
      $('#curation-info-modal-header').addClass("bg-secondary text-light");

      $('#curation-info-modal-header').addClass("border-secondary");
      $('#curation-info-modal-header').removeClass("border-success");
    }
    $('#curation-info-modal').modal('show');
  }

  // extract main element id
  function extractElementId(currentId) {
    let key = ""
    let idx = currentId.indexOf("_");
    key = currentId.substr(idx + 1);
    return key
  }
</script>

</html>